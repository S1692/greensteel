# ============================================================================
# ğŸš€ DataGather Service - Main Application
# ============================================================================

import asyncio
import logging
from contextlib import asynccontextmanager
from fastapi import FastAPI, HTTPException, Depends, UploadFile, File, Form
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import JSONResponse
from sqlalchemy.ext.asyncio import AsyncSession
from typing import Optional, Dict, Any
import uvicorn

from .infrastructure.database import database
from .infrastructure.config import settings
from .application.datagather_application_service import DataGatherApplicationService

# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=getattr(logging, settings.log_level),
    format=settings.log_format
)
logger = logging.getLogger(__name__)

@asynccontextmanager
async def lifespan(app: FastAPI):
    """ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒëª…ì£¼ê¸° ê´€ë¦¬"""
    # ì‹œì‘ ì‹œ
    logger.info("ğŸš€ DataGather Serviceë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
    
    # ì„¤ì • ìœ íš¨ì„± ê²€ì¦
    if not settings.validate():
        raise RuntimeError("ì„¤ì • ìœ íš¨ì„± ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
    
    # ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
    await database.init_db()
    
    logger.info("âœ… DataGather Serviceê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.")
    
    yield
    
    # ì¢…ë£Œ ì‹œ
    logger.info("ğŸ›‘ DataGather Serviceë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤...")

# FastAPI ì•± ìƒì„±
app = FastAPI(
    title=settings.app_name,
    version=settings.app_version,
    description="Data Collection & Processing Service - DDD Structure",
    lifespan=lifespan
)

# CORS ì„¤ì •
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ì˜ì¡´ì„± ì£¼ì… í•¨ìˆ˜
async def get_session() -> AsyncSession:
    """ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ ì˜ì¡´ì„±"""
    async for session in database.get_session():
        yield session

async def get_datagather_service(session: AsyncSession = Depends(get_session)) -> DataGatherApplicationService:
    """DataGather ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ì˜ì¡´ì„±"""
    return DataGatherApplicationService(session)

# ë£¨íŠ¸ ì—”ë“œí¬ì¸íŠ¸
@app.get("/")
async def root():
    """ë£¨íŠ¸ ê²½ë¡œ"""
    return {
        "service": "DataGather Service",
        "version": "1.0.0",
        "description": "Data Collection & Processing Service - DDD Structure",
        "endpoints": {
            "health": "/health",
            "ai_process": "/ai-process",
            "ai_process_api": f"{settings.api_prefix}/datagather/ai-process",
            "documentation": "/docs"
        }
    }

# í—¬ìŠ¤ì²´í¬ ì—”ë“œí¬ì¸íŠ¸
@app.get("/health")
async def health_check():
    """ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸"""
    try:
        db_healthy = await database.health_check()
        return {
            "status": "healthy" if db_healthy else "unhealthy",
            "service": settings.app_name,
            "version": settings.app_version,
            "database": "connected" if db_healthy else "disconnected"
        }
    except Exception as e:
        logger.error(f"í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨: {e}")
        return JSONResponse(
            status_code=500,
            content={"status": "error", "error": str(e)}
        )

# AI ì²˜ë¦¬ ê´€ë ¨ ì—”ë“œí¬ì¸íŠ¸
@app.post("/ai-process")
async def ai_process_data(
    data: Dict[str, Any],
    service: DataGatherApplicationService = Depends(get_datagather_service)
):
    """AI ë°ì´í„° ì²˜ë¦¬ - DDD êµ¬ì¡° ì‚¬ìš©"""
    try:
        logger.info(f"ğŸ¤– AI ë°ì´í„° ì²˜ë¦¬ ìš”ì²­: {data.get('data_type', 'unknown')}")
        
        # DDD êµ¬ì¡°ë¥¼ ì‚¬ìš©í•œ API ë°ì´í„° ì²˜ë¦¬
        result = await service.process_api_data(
            install_id=data.get('install_id', 1),
            api_data=data,
            data_type=data.get('data_type', 'ai_processed'),
            process_id=data.get('process_id')
        )
        
        if result["success"]:
            logger.info("âœ… AI ë°ì´í„° ì²˜ë¦¬ ì„±ê³µ")
            return JSONResponse(
                status_code=200,
                content={
                    "success": True,
                    "message": "AI ë°ì´í„° ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
                    "data_gather_id": result.get("data_gather_id"),
                    "saved_count": result.get("saved_count"),
                    "processed_data": data
                }
            )
        else:
            logger.error(f"âŒ AI ë°ì´í„° ì²˜ë¦¬ ì‹¤íŒ¨: {result}")
            return JSONResponse(
                status_code=400,
                content=result
            )
            
    except Exception as e:
        logger.error(f"âŒ AI ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: {e}")
        return JSONResponse(
            status_code=500,
            content={
                "success": False,
                "error": str(e),
                "message": "AI ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
            }
        )

@app.post(f"{settings.api_prefix}/datagather/ai-process")
async def ai_process_data_with_prefix(
    data: Dict[str, Any],
    service: DataGatherApplicationService = Depends(get_datagather_service)
):
    """AI ë°ì´í„° ì²˜ë¦¬ (API prefix í¬í•¨)"""
    return await ai_process_data(data, service)

# Gatewayì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²½ë¡œ (API prefix ì—†ì´)
@app.post("/api/datagather/ai-process")
async def ai_process_data_gateway(
    data: Dict[str, Any],
    service: DataGatherApplicationService = Depends(get_datagather_service)
):
    """AI ë°ì´í„° ì²˜ë¦¬ (Gateway ê²½ë¡œ)"""
    return await ai_process_data(data, service)

if __name__ == "__main__":
    uvicorn.run(
        "app.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.debug,
        log_level=settings.log_level.lower()
    )